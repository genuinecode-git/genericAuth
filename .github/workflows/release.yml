name: Release Build & Docker Package

on:
  workflow_dispatch:
    inputs:
      version_increment:
        description: 'Version increment type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'GenericAuth.sln'
  DOCKER_IMAGE_NAME: 'genericauth-api'
  REGISTRY: ghcr.io

jobs:
  build-test-release:
    name: Build, Test & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Get current version
      id: get_version
      run: |
        if [ -f "VERSION" ]; then
          CURRENT_VERSION=$(cat VERSION)
        else
          CURRENT_VERSION="1.0.0.0"
          echo "$CURRENT_VERSION" > VERSION
        fi
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Increment version
      id: increment_version
      run: |
        VERSION="${{ steps.get_version.outputs.current_version }}"
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION"

        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        BUILD=${VERSION_PARTS[3]}

        # Increment based on input or default to patch (last bit)
        INCREMENT_TYPE="${{ github.event.inputs.version_increment }}"
        if [ -z "$INCREMENT_TYPE" ] || [ "$INCREMENT_TYPE" == "patch" ]; then
          BUILD=$((BUILD + 1))
        elif [ "$INCREMENT_TYPE" == "minor" ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
          BUILD=0
        elif [ "$INCREMENT_TYPE" == "major" ]; then
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
          BUILD=0
        fi

        NEW_VERSION="$MAJOR.$MINOR.$PATCH.$BUILD"
        echo "$NEW_VERSION" > VERSION

        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"

        # Also create a semver format (without the build number for tagging)
        SEMVER="$MAJOR.$MINOR.$PATCH"
        echo "semver=$SEMVER" >> $GITHUB_OUTPUT

    - name: Commit version update
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add VERSION
        git commit -m "chore: Bump version to ${{ steps.increment_version.outputs.new_version }}" || echo "No changes to commit"
        git push || echo "Nothing to push"

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

    - name: Run all tests
      run: |
        dotnet test ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build \
          -t ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.increment_version.outputs.new_version }} \
          -t ${{ env.DOCKER_IMAGE_NAME }}:latest \
          -t ${{ env.DOCKER_IMAGE_NAME }}:v${{ steps.increment_version.outputs.semver }} \
          --build-arg BUILD_CONFIGURATION=Release \
          -f Dockerfile \
          .

    - name: Create release directory
      run: mkdir -p release

    - name: Save Docker image to tar
      run: |
        docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.increment_version.outputs.new_version }} \
          -o release/${{ env.DOCKER_IMAGE_NAME }}-${{ steps.increment_version.outputs.new_version }}.tar

        # Also save the latest tag
        docker save ${{ env.DOCKER_IMAGE_NAME }}:latest \
          -o release/${{ env.DOCKER_IMAGE_NAME }}-latest.tar

    - name: Compress Docker images
      run: |
        cd release
        gzip ${{ env.DOCKER_IMAGE_NAME }}-${{ steps.increment_version.outputs.new_version }}.tar
        gzip ${{ env.DOCKER_IMAGE_NAME }}-latest.tar

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release/RELEASE_NOTES.md << EOF
        # GenericAuth API Release v${{ steps.increment_version.outputs.new_version }}

        ## Version Information
        - **Version**: ${{ steps.increment_version.outputs.new_version }}
        - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Git Commit**: ${{ github.sha }}

        ## Docker Images
        This release includes pre-built Docker images:
        - \`${{ env.DOCKER_IMAGE_NAME }}:${{ steps.increment_version.outputs.new_version }}\`
        - \`${{ env.DOCKER_IMAGE_NAME }}:latest\`
        - \`${{ env.DOCKER_IMAGE_NAME }}:v${{ steps.increment_version.outputs.semver }}\`

        ## Installation

        ### Load Docker Image from tar.gz
        \`\`\`bash
        # Extract and load the image
        gunzip -c ${{ env.DOCKER_IMAGE_NAME }}-${{ steps.increment_version.outputs.new_version }}.tar.gz | docker load

        # Run the container
        docker run -d -p 8080:8080 -p 8081:8081 \\
          --name genericauth-api \\
          ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.increment_version.outputs.new_version }}
        \`\`\`

        ## What's Changed
        - Build completed successfully with all tests passing
        - Docker image built and packaged for distribution

        ## Changelog
        See commit history for detailed changes since last release.
        EOF

    - name: Create checksums
      run: |
        cd release
        sha256sum *.tar.gz > checksums.txt
        cat checksums.txt

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-v${{ steps.increment_version.outputs.new_version }}
        path: |
          release/*.tar.gz
          release/RELEASE_NOTES.md
          release/checksums.txt
        retention-days: 90

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.increment_version.outputs.new_version }}
        name: Release v${{ steps.increment_version.outputs.new_version }}
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          release/*.tar.gz
          release/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release summary
      run: |
        echo "## Release Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Version**: v${{ steps.increment_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Docker Image**: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.increment_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build**: Successful" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Tests**: All Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Release**: Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Images Available:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.DOCKER_IMAGE_NAME }}-${{ steps.increment_version.outputs.new_version }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.DOCKER_IMAGE_NAME }}-latest.tar.gz\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ All artifacts uploaded to GitHub Release" >> $GITHUB_STEP_SUMMARY
